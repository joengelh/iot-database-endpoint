version: '3'
services:
  api:
   build: ./container-api/
   restart: always
   ports: 
   - 10000:80
   env_file:
   - .env
   depends_on:
   - db
  db:
   image: postgres
   restart: always
   env_file:
   - .env
   ports:
    - "9999:5432"
   volumes:
   - /home/db/test:/var/lib/postgresql/data:rw
   - ./container-db/initdb.d:/docker-entrypoint-initdb.d
  webserver:
   image: nginx:latest
   ports:
   - 80:80
   - 443:443
   restart: always
   depends_on:
   - api
   - db
   volumes:
   - ./nginx/conf/:/etc/nginx/conf.d/:ro
   - ./certbot/www:/var/www/certbot/:ro
   - ./certbot/conf/:/etc/letsencrypt/:ro
   command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
  certbot:
   image: certbot/certbot:latest
   volumes:
   - ./certbot/www/:/var/www/certbot/:rw
   - ./certbot/conf/:/etc/letsencrypt/:rw
   entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
